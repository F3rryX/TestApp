name: Save Quiz Results

on:
  repository_dispatch:
    types: [save-quiz-result]

permissions:
  contents: write

jobs:
  save-result:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Save to CSV
        env:
          PLAYER_NAME: ${{ github.event.client_payload.player_name }}
          TIME: ${{ github.event.client_payload.time }}
          SCORE: ${{ github.event.client_payload.score }}
          TOTAL: ${{ github.event.client_payload.total }}
          PERCENTAGE: ${{ github.event.client_payload.percentage }}
          DATE: ${{ github.event.client_payload.date }}
          QUESTIONS: ${{ github.event.client_payload.questions }}
          TIME_PER_Q: ${{ github.event.client_payload.time_per_question }}
          MODE: ${{ github.event.client_payload.mode }}
        run: |
          # Create CSV line
          CSV_LINE="${PLAYER_NAME};${TIME};${SCORE}/${TOTAL};${PERCENTAGE}%;${DATE};${QUESTIONS};${TIME_PER_Q}"
          
          # Ensure CSV files exist with headers
          if [ ! -f CSV/Tutte.csv ]; then
            echo "Nome;Tempo;Corrette;Percentuale;Data;Domande;TempoDomanda" > CSV/Tutte.csv
          fi
          if [ ! -f CSV/Torneo.csv ]; then
            echo "Nome;Tempo;Corrette;Percentuale;Data;Domande;TempoDomanda" > CSV/Torneo.csv
          fi
          if [ ! -f CSV/Custom.csv ]; then
            echo "Nome;Tempo;Corrette;Percentuale;Data;Domande;TempoDomanda" > CSV/Custom.csv
          fi
          
          # Append to Tutte.csv (all games) with newline
          echo "${CSV_LINE}" >> CSV/Tutte.csv
          
          # For tournament mode
          if [ "$MODE" = "tournament" ]; then
            # Check if player already has a record
            if grep -q "^${PLAYER_NAME};" CSV/Torneo.csv 2>/dev/null; then
              # Get existing time
              EXISTING_TIME=$(grep "^${PLAYER_NAME};" CSV/Torneo.csv | cut -d';' -f2 | sort -n | head -1)
              # Compare times (lower is better)
              if [ "$(echo "$TIME < $EXISTING_TIME" | bc)" -eq 1 ]; then
                # Remove old record and add new one
                sed -i "/^${PLAYER_NAME};/d" CSV/Torneo.csv
                echo "${CSV_LINE}" >> CSV/Torneo.csv
              fi
            else
              # No existing record, add this one
              echo "${CSV_LINE}" >> CSV/Torneo.csv
            fi
          else
            # Custom mode - save all games
            echo "${CSV_LINE}" >> CSV/Custom.csv
          fi

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add CSV/*.csv
          git diff --quiet && git diff --staged --quiet ||           git commit -m "Add quiz result: ${{ github.event.client_payload.player_name }} - ${{ github.event.client_payload.score }}/${{ github.event.client_payload.total }}"
          git push
